{% extends 'base.html' %}
{% load static %}

{% block title %}Crear Orden de Servicio{% endblock %}

{% block content %}
    <div class="d-flex justify-content-end mb-4">
        <a href="{% url 'logout' %}" class="btn btn-danger">Cerrar Sesión</a>
    </div>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="header">
            <div class="logo">
                TU LOGOTIPO<br>EN ESTA PARTE
            </div>
            <div class="title">
                Taller de Motocicletas<br>
                <span style="font-size: 20px; font-weight: normal;">Orden de Servicio</span>
            </div>
            <div class="mecanico">
                <label>MECÁNICO RESPONSABLE</label>
                <select class="form-control" name="mechanic" required>
                    <option value="">Seleccione un mecánico</option>
                    {% for mechanic in mechanics %}
                        <option value="{{ mechanic.id }}">{{ mechanic.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="section-title">DATOS DEL CLIENTE</div>
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label for="nombre">Nombre:</label>
                        <input type="text" id="nombre" name="nombre" class="form-control" required minlength="3" maxlength="100">
                    </div>
                    <div class="col-md-6 form-group">
                        <label for="domicilio">Domicilio:</label>
                        <input type="text" id="domicilio" name="domicilio" class="form-control" required minlength="5" maxlength="200">
                    </div>
                    <div class="col-md-6 form-group">
                        <label for="telefono">Teléfono:</label>
                        <input type="tel" id="telefono" name="telefono" class="form-control" required pattern="[0-9]{10}" title="Número de teléfono a 10 dígitos">
                    </div>
                    <div class="col-md-6 form-group">
                        <label for="whatsapp">Whatsapp:</label>
                        <input type="tel" id="whatsapp" name="whatsapp" class="form-control" pattern="[0-9]{10}" title="Número de WhatsApp a 10 dígitos">
                    </div>
                    <div class="col-md-6 form-group">
                        <label for="correo">Correo:</label>
                        <input type="email" id="correo" name="correo" class="form-control" required>
                    </div>

                </div>
            </div>
            <div class="col-md-4">
                <div class="card mt-4 p-3">
                    <div class="form-group">
                        <label for="fecha">Fecha:</label>
                        <input type="date" id="fecha" name="fecha" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="hora">Hora:</label>
                        <input type="time" id="hora" name="hora" class="form-control" required>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-title mt-4">DATOS DEL VEHÍCULO</div>
        <div class="row">
            <div class="col-md-8">
                <div class="row">
                    <div class="col-md-6 form-group">
                        <label for="marca">Marca:</label>
                        <input type="text" id="marca" name="marca" class="form-control" required minlength="2" maxlength="50">
                    </div>
                    <div class="col-md-6 form-group">
                        <label for="modelo">Modelo:</label>
                        <input type="text" id="modelo" name="modelo" class="form-control" required minlength="2" maxlength="50">
                    </div>
                    <div class="col-md-6 form-group">
                        <label for="color">Color:</label>
                        <input type="text" id="color" name="color" class="form-control" required minlength="2" maxlength="30">
                    </div>
                    <div class="col-md-6 form-group">
                        <label for="no_serie">No. Serie:</label>
                        <input type="text" id="no_serie" name="no_serie" class="form-control" required minlength="5" maxlength="50">
                    </div>
                    <div class="col-md-6 form-group">
                        <label for="no_motor">No. Motor:</label>
                        <input type="text" id="no_motor" name="no_motor" class="form-control" required minlength="5" maxlength="50">
                    </div>
                </div>
            </div>
            <div class="col-md-4 d-flex flex-column justify-content-center align-items-center">
                <div class="section-title w-100 text-center">PLACAS</div>
                <input type="text" name="placa" class="form-control text-center w-100 mt-2" placeholder="ABC-123" required pattern="[A-Z0-9]{1,3}[ -]?[A-Z0-9]{3,4}">
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12 card p-3">
                <div class="row">
                    <div class="col-md-6 text-center form-group">
                        <label>Kilometraje</label>
                        <input type="number" name="kilometraje" class="form-control" placeholder="Escribir km..." required min="0">
                    </div>
                    <div class="col-md-6 text-center form-group">
                        <label for="gasolina_range">Gasolina: <span id="gasolina_value">0%</span></label>
                        <input type="range" id="gasolina_range" name="gasolina" class="form-control-range" min="0" max="100" value="0">
                    </div>
                </div>
            </div>
        </div>

        <div class="section-title mt-4">ESTADO GENERAL DE LA MOTOCICLETA</div>
        <div class="row">
            <div class="col-md-6">
                <div class="section-title">INVENTARIO GENERAL</div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th></th>
                                <th class="text-center">SÍ</th>
                                <th class="text-center">NO</th>
                                <th class="text-center">ESPECIFIQUE</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-items-container"></tbody>
                    </table>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card p-3 mb-3">
                    <label class="text-center font-weight-bold text-warning mb-2">FALLA PRINCIPAL DETECTADA</label>
                    <textarea class="form-control" name="falla_principal" rows="4" required minlength="10"></textarea>
                </div>

                <div class="section-title">ESTADO GENERAL</div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card p-3 h-100">
                            <h4 class="text-center mb-2">Motor & Transmisión</h4>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="motor" id="motor_bueno" value="bueno" required>
                                <label class="form-check-label" for="motor_bueno">Buen estado</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="motor" id="motor_malo" value="malo">
                                <label class="form-check-label" for="motor_malo">Mal estado</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="motor" id="motor_atencion" value="atencion">
                                <label class="form-check-label" for="motor_atencion">Reg. Atención</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card p-3 h-100">
                            <h4 class="text-center mb-2">Sistema Eléctrico</h4>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="electrico" id="electrico_bueno" value="bueno" required>
                                <label class="form-check-label" for="electrico_bueno">Buen estado</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="electrico" id="electrico_malo" value="malo">
                                <label class="form-check-label" for="electrico_malo">Mal estado</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="electrico" id="electrico_atencion" value="atencion">
                                <label class="form-check-label" for="electrico_atencion">Reg. Atención</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card p-3 h-100">
                            <h4 class="text-center mb-2">Discos y Balatas</h4>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="frenos" id="frenos_bueno" value="bueno" required>
                                <label class="form-check-label" for="frenos_bueno">Buen estado</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="frenos" id="frenos_malo" value="malo">
                                <label class="form-check-label" for="frenos_malo">Mal estado</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="frenos" id="frenos_atencion" value="atencion">
                                <label class="form-check-label" for="frenos_atencion">Reg. Atención</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card p-3 h-100">
                            <h4 class="text-center mb-2">Suspensión</h4>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="suspension" id="suspension_bueno" value="bueno" required>
                                <label class="form-check-label" for="suspension_bueno">Buen estado</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="suspension" id="suspension_malo" value="malo">
                                <label class="form-check-label" for="suspension_malo">Mal estado</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="suspension" id="suspension_atencion" value="atencion">
                                <label class="form-check-label" for="suspension_atencion">Reg. Atención</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card p-3 h-100">
                            <h4 class="text-center mb-2">Nivel de Líquidos</h4>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="liquidos" id="liquidos_bueno" value="bueno" required>
                                <label class="form-check-label" for="liquidos_bueno">Buen estado</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="liquidos" id="liquidos_malo" value="malo">
                                <label class="form-check-label" for="liquidos_malo">Mal estado</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="liquidos" id="liquidos_atencion" value="atencion">
                                <label class="form-check-label" for="liquidos_atencion">Reg. Atención</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card p-3 h-100">
                            <h4 class="text-center mb-2">Llantas y Rodamiento</h4>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="llantas" id="llantas_bueno" value="bueno" required>
                                <label class="form-check-label" for="llantas_bueno">Buen estado</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="llantas" id="llantas_malo" value="malo">
                                <label class="form-check-label" for="llantas_malo">Mal estado</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="llantas" id="llantas_atencion" value="atencion">
                                <label class="form-check-label" for="llantas_atencion">Reg. Atención</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card p-3 h-100">
                            <h4 class="text-center mb-2">Afinación</h4>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="afinacion" id="afinacion_bueno" value="bueno" required>
                                <label class="form-check-label" for="afinacion_bueno">Buen estado</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="afinacion" id="afinacion_malo" value="malo">
                                <label class="form-check-label" for="afinacion_malo">Mal estado</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="afinacion" id="afinacion_atencion" value="atencion">
                                <label class="form-check-label" for="afinacion_atencion">Reg. Atención</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card p-3 h-100">
                            <h4 class="text-center mb-2">Otros</h4>
                            <textarea class="form-control" name="otros" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                 <div id="drop-zone" class="moto-placeholder mt-3 p-3 text-center">
                    Arrastra y suelta una imagen aquí o haz clic para seleccionarla
                    <input type="file" id="file-input" accept="image/*" style="display: none;">
                    <img id="preview-image" src="" alt="Vista previa de la imagen" style="max-width: 100%; max-height: 200px; margin-top: 10px; display: none;">
                </div>
            </div>
        </div>

        <div class="row mt-4 card p-3">
            <div class="col-md-8">
                <div class="section-title">GARANTÍA DEL SERVICIO</div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-3">
                            <label class="mr-3">INCLUIDA</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="garantia" id="g_si" value="si" required>
                                <label class="form-check-label" for="g_si">Sí</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="garantia" id="g_no" value="no" required>
                                <label class="form-check-label" for="g_no">No</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Válida desde:</label>
                            <input type="date" name="valida_desde" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Válida hasta:</label>
                            <input type="date" name="valida_hasta" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>A excepción de:</label>
                            <input type="text" name="excepcion" class="form-control" maxlength="200">
                        </div>
                    </div>
                </div>
            </div>

        <div class="row mt-4 justify-content-center">
            <div class="col-md-6">
                <div class="section-title">PRESUPUESTO GRAL.</div>
                <div class="card p-3">
                    <div class="row">
                        <div class="col-md-6 form-group">
                            <label for="anticipo">ANTICIPO</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">$</span>
                                </div>
                                <input type="number" id="anticipo" name="anticipo" class="form-control text-right" required min="0" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-6 form-group">
                            <label for="restan">RESTAN</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">$</span>
                                </div>
                                <input type="number" id="restan" name="restan" class="form-control text-right" required min="0" step="0.01">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <div class="firma text-center mt-4">
            FIRMA DE ACEPTACIÓN<br>DEL CLIENTE
            <div class="signature-box mt-3 mx-auto" style="height: 100px; width: 300px; border: 1px solid var(--border-color);"></div>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary">Guardar Orden</button>
            <a href="{% url 'search' %}" class="btn btn-secondary ml-2">Cancelar</a>
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const items = ["Tablero completo", "Direccionales", "Claxon", "Botones", "Espejos Retrovisores", "Calavera stop", "Porta placa", "Cuartos", "Manijas de freno", "Manijas de clutch", "Puños", "Escape", "Posapies delanteros", "Posapies traseros", "Chicote Clutch", "Rin Delantero", "Rin Trasero", "Faro", "Cable de bujía", "Kit H(S)", "Accesorios", "Otros"];
            const container = document.getElementById('inventory-items-container');

            items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item}</td>
                    <td class="text-center"><input type="radio" name="item_${index}" value="si" class="form-check-input"></td>
                    <td class="text-center"><input type="radio" name="item_${index}" value="no" class="form-check-input"></td>
                    <td><input type="text" placeholder="..." class="form-control form-control-sm"></td>
                `;
                container.appendChild(tr);
            });

            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            const previewImage = document.getElementById('preview-image');

            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('bg-secondary');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('bg-secondary');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('bg-secondary');
                const file = e.dataTransfer.files[0];
                handleFile(file);
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                handleFile(file);
            });

            function handleFile(file) {
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImage.src = e.target.result;
                        previewImage.style.display = 'block';
                        dropZone.childNodes[0].nodeValue = '';
                    }
                    reader.readAsDataURL(file);
                }
            }

            const gasolinaRange = document.getElementById('gasolina_range');
            const gasolinaValue = document.getElementById('gasolina_value');

            gasolinaRange.addEventListener('input', () => {
                gasolinaValue.textContent = `${gasolinaRange.value}%`;
            });

            // Initialize value on load
            gasolinaValue.textContent = `${gasolinaRange.value}%`;
        });
    </script>
{% endblock %}